const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');
const axios = require('axios');
require('dotenv').config();
const OpenAI = require('openai');

// Carga de datos
const data = require('./data.json');
const promoData = require('./promoData.json');
const systemPrompt = fs.readFileSync('./SystemPrompt.txt', 'utf-8');

// Memoria y estados (basados en tu bot de Messenger)
const memoriaConversacion = {};
const estadoUsuario = {};
let primerMensaje = {};
let timersInactividad = {};

const app = express();
app.use(bodyParser.json());

// Variables de Entorno
const PORT = process.env.PORT || 3000;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const MANYCHAT_API_KEY = process.env.MANYCHAT_API_KEY;
const client = new OpenAI({ apiKey: OPENAI_API_KEY });


// ===== MANEJADOR PRINCIPAL DE MENSAJES =====
app.post('/webhook', async (req, res) => {
    console.log('--- NUEVA SOLICITUD ---');
    console.log('üì© Webhook recibido:', JSON.stringify(req.body, null, 2));

    const from = req.body.id;
    const textFromUser = req.body.last_input_text || '';
    const payload = req.body.payload || null;

    if (!from) return res.status(400).send('Falta ID de usuario.');
    
    reiniciarTimerInactividad(from);

    let messagesToSend = [];

    // --- PRIORIDAD 1: Clics en Botones (Payload) ---
    if (payload && payload.action) {
        const action = payload.action.toUpperCase();
        console.log(`ü§ñ Procesando PAYLOAD de bot√≥n: ${action}`);
        primerMensaje[from] = true;
        
        switch (action) {
            case 'CABALLEROS': messagesToSend = construirSubmenuTipoReloj('CABALLEROS'); break;
            case 'DAMAS': messagesToSend = construirSubmenuTipoReloj('DAMAS'); break;
            case 'CABALLEROS_AUTO': messagesToSend = construirCatalogo('caballeros_automaticos'); break;
            case 'CABALLEROS_CUARZO': messagesToSend = construirCatalogo('caballeros_cuarzo'); break;
            case 'DAMAS_AUTO': messagesToSend = construirCatalogo('damas_automaticos'); break;
            case 'DAMAS_CUARZO': messagesToSend = construirCatalogo('damas_cuarzo'); break;
            case 'VER_MODELOS': messagesToSend = construirMenuPrincipal(); break;
            default:
                // Si la acci√≥n del bot√≥n requiere IA, pasa al procesamiento de texto
                messagesToSend = await procesarConsultaConChatGPT(from, action);
                break;
        }
    
    // --- PRIORIDAD 2: Mensajes de texto ---
    } else if (textFromUser) {
        console.log(`üí¨ Procesando TEXTO: ${textFromUser}`);
        if (!primerMensaje[from]) {
            primerMensaje[from] = true;
            messagesToSend = construirMenuPrincipal();
        } else {
            messagesToSend = await procesarConsultaConChatGPT(from, textFromUser);
        }

    // --- PRIORIDAD 3: Primer contacto sin texto ---
    } else if (!primerMensaje[from]) {
        primerMensaje[from] = true;
        messagesToSend = construirMenuPrincipal();
    }

    if (messagesToSend && messagesToSend.length > 0) {
        responderAManyChat(res, messagesToSend);
    } else {
        res.sendStatus(200);
    }
});


// ===== FUNCI√ìN DE CONSULTA A OPENAI (DEVUELVE EL MENSAJE A ENVIAR) =====
async function procesarConsultaConChatGPT(senderId, mensajeCliente) {
    try {
        console.log(`üß† Enviando a ChatGPT: "${mensajeCliente}"`);
        if (!memoriaConversacion[senderId]) memoriaConversacion[senderId] = [];
        memoriaConversacion[senderId].push({ role: 'user', content: mensajeCliente });

        const contexto = [{ role: 'system', content: systemPrompt }, ...memoriaConversacion[senderId]];
        const response = await client.chat.completions.create({ model: 'gpt-4o', messages: contexto });
        const respuesta = response.choices[0].message.content.trim();
        memoriaConversacion[senderId].push({ role: 'assistant', content: respuesta });
        
        console.log(`ü§ñ Respuesta de ChatGPT: ${respuesta}`);

        if (respuesta.startsWith('MOSTRAR_MODELO:')) {
            const codigo = respuesta.split(':')[1].trim();
            const producto = Object.values(data).flat().find(p => p.codigo.toUpperCase().includes(codigo.toUpperCase())) || 
                           Object.values(promoData).find(p => p.nombre.toUpperCase().includes(codigo.toUpperCase()));
            return producto ? construirMensajeInfoPromo(producto) : [{ type: 'text', text: `üòî Lo siento, no pude encontrar el modelo con c√≥digo ${codigo}.` }];
        }
        if (respuesta === 'PEDIR_CATALOGO') return construirMenuPrincipal();
        if (respuesta.startsWith('PREGUNTAR_TIPO:')) {
            const genero = respuesta.split(':')[1].trim().toUpperCase();
            return construirSubmenuTipoReloj(genero);
        }
        if (respuesta.startsWith('MOSTRAR_CATALOGO:')) {
            const tipo = respuesta.split(':')[1].trim();
            return construirCatalogo(tipo);
        }
        
        return [{ type: 'text', text: respuesta }];

    } catch (error) {
        console.error('‚ùå Error en consulta a ChatGPT:', error);
        return [{ type: 'text', text: '‚ö†Ô∏è Lo siento, hubo un problema con el asesor. Intente nuevamente.' }];
    }
}


// ===== FUNCI√ìN DE RESPUESTA √öNICA Y DIRECTA A MANYCHAT =====
function responderAManyChat(res, messages = []) {
    const response = { version: "v2", content: { messages } };
    console.log("üì¢ Respondiendo a ManyChat:", JSON.stringify(messages, null, 2));
    res.json(response);
}


// ===== FUNCIONES "CONSTRUCTORAS" DE MENSAJES (TRADUCIDAS DE TU BOT DE MESSENGER) =====
function construirMenuPrincipal() {
    return [{
        type: 'text', text: 'üëã ¬°Hola! Bienvenido a Tiendas Megan\nüíé Descubra su reloj ideal o el regalo perfecto üéÅ\nElige una opci√≥n para ayudarte üëá',
        buttons: [
            { type: 'dynamic_block_callback', caption: '‚åö Para Caballeros', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: 'CABALLEROS' }},
            { type: 'dynamic_block_callback', caption: 'üïí Para Damas', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: 'DAMAS' }},
            { type: 'dynamic_block_callback', caption: 'üí¨ Hablar con Asesor', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: 'ASESOR' }}
        ]
    }];
}

function construirSubmenuTipoReloj(genero) {
    const texto = genero === "CABALLEROS" 
        ? "üî• ¬°Excelente elecci√≥n! ¬øQu√© tipo de reloj para caballeros le interesa?"
        : "üî• ¬°Excelente elecci√≥n! ¬øQu√© tipo de reloj para damas le interesa?";
    const payloadAuto = genero === "CABALLEROS" ? "CABALLEROS_AUTO" : "DAMAS_AUTO";
    const payloadCuarzo = genero === "CABALLEROS" ? "CABALLEROS_CUARZO" : "DAMAS_CUARZO";
    
    return [{
        type: 'text', text: texto,
        buttons: [
            { type: 'dynamic_block_callback', caption: '‚åö Autom√°ticos ‚öôÔ∏è', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: payloadAuto }},
            { type: 'dynamic_block_callback', caption: 'üïë De cuarzo ‚ú®', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: payloadCuarzo }}
        ]
    }];
}

function construirCatalogo(tipo) {
    const productos = data[tipo];
    if (!productos || !productos.length) return [{ type: 'text', text: 'üòî No hay productos disponibles.' }];
    
    const elements = productos.map(p => ({
        title: p.nombre, subtitle: `${p.descripcion}\nüí∞ Precio: S/${p.precio}`, image_url: p.imagen,
        buttons: [
            { type: 'dynamic_block_callback', caption: 'üõçÔ∏è Comprar ahora', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: `COMPRAR_${p.codigo}` }},
            { type: 'web_url', caption: 'üìû Comprar por WhatsApp', url: "https://wa.me/51904805167?text=Hola%20quiero%20comprar%20este%20modelo" },
            { type: 'dynamic_block_callback', caption: 'üìñ Ver otros modelos', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: 'VER_MODELOS' }}
        ]
    }));
    return [{ type: 'cards', elements: elements, image_aspect_ratio: 'square' }];
}

function construirMensajeInfoPromo(producto) {
    if (!producto) return [{ type: 'text', text: '‚ö†Ô∏è No se pudo encontrar la promo.' }];
    return [{
        type: 'cards', elements: [{
            title: producto.nombre, subtitle: `${producto.descripcion}\nüí∞ Precio: S/${producto.precio}`, image_url: producto.imagen,
            buttons: [
                { type: 'dynamic_block_callback', caption: 'üõçÔ∏è Comprar ahora', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: `COMPRAR_${producto.codigo}` }},
                { type: 'web_url', caption: 'üìû Comprar por WhatsApp', url: "https://wa.me/51904805167?text=Hola%20quiero%20comprar%20este%20modelo" },
                { type: 'dynamic_block_callback', caption: 'üìñ Ver otros modelos', url: process.env.RAILWAY_APP_URL + '/webhook', payload: { action: 'VER_MODELOS' }}
            ]
        }], image_aspect_ratio: 'square'
    }];
}

// ===== L√ìGICA DE INACTIVIDAD (ADAPTADA PARA MANYCHAT) =====
async function enviarMensajeProactivoManyChat(subscriberId, messages) {
    if (!MANYCHAT_API_KEY) return console.error("### ERROR CR√çTICO: MANYCHAT_API_KEY no definida. ###");
    
    const url = 'https://api.manychat.com/fb/sending/sendContent';
    const headers = { 'Authorization': `Bearer ${MANYCHAT_API_KEY}`, 'Content-Type': 'application/json' };
    const body = {
        subscriber_id: subscriberId,
        data: { version: 'v2', content: { messages } },
        message_tag: "POST_PURCHASE_UPDATE" // Etiqueta necesaria para enviar mensajes fuera de la ventana de 24h
    };

    try {
        console.log(`üì§ Enviando mensaje proactivo de inactividad a ${subscriberId}`);
        await axios.post(url, body, { headers });
        console.log(`‚úÖ Mensaje proactivo de inactividad enviado con √©xito.`);
    } catch (error) {
        console.error("### ERROR AL ENVIAR MENSAJE PROACTIVO ###", error.response ? error.response.data : error.message);
    }
}

function reiniciarTimerInactividad(senderId) {
    limpiarTimers(senderId);
    const timer10 = setTimeout(() => enviarAvisoInactividad(senderId), 10 * 60 * 1000);
    const timer12 = setTimeout(() => finalizarSesion(senderId), 12 * 60 * 1000);
    timersInactividad[senderId] = { timer10, timer12 };
}

function limpiarTimers(senderId) {
    if (timersInactividad[senderId]) {
        clearTimeout(timersInactividad[senderId].timer10);
        clearTimeout(timersInactividad[senderId].timer12);
        delete timersInactividad[senderId];
    }
}

async function enviarAvisoInactividad(senderId) {
    console.log(`‚è≥ Enviando aviso de inactividad a ${senderId}`);
    const messages = [{
        type: 'text', text: '¬øLe gustar√≠a que le ayudemos en algo m√°s o desea continuar la conversaci√≥n con un asesor por WhatsApp?',
        buttons: [{ type: 'web_url', caption: 'üìû Continuar en WhatsApp', url: "https://wa.me/51904805167" }]
    }];
    await enviarMensajeProactivoManyChat(senderId, messages);
}

async function finalizarSesion(senderId) {
    console.log(`‚åõ Finalizando sesi√≥n por inactividad para ${senderId}`);
    delete memoriaConversacion[senderId];
    delete primerMensaje[senderId];
    limpiarTimers(senderId);
    await enviarMensajeProactivoManyChat(senderId, [{type: 'text', text: "‚è≥ Su sesi√≥n ha terminado."}]);
}


app.listen(PORT, () => {
  console.log(`üöÄ Servidor para ManyChat escuchando en http://0.0.0.0:${PORT}`);
});